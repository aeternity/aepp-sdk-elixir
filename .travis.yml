dist: xenial
sudo: true

language: elixir
elixir: '1.8'

env:
  global:
    - LD_LIBRARY_PATH=$HOME/.libsodium/lib:$LD_LIBRARY_PATH
    - LD_RUN_PATH=$HOME/.libsodium/lib:$LD_RUN_PATH
    - PATH=$PATH:$HOME/.libsodium/lib:$HOME/.libsodium/include:$HOME/.kiex
    - LIBRARY_PATH=$HOME/.libsodium/lib:$LIBRARY_PATH
    - C_INCLUDE_PATH=$HOME/.libsodium/include:$C_INCLUDE_PATH
  matrix:
    - LIBSODIUM_VER=1.0.16

before_install: 
  - bash <(curl -s https://raw.githubusercontent.com/aeternity/installer/v2.0.0/install.sh)
  - mkdir -p $HOME/.epoch/epoch/
  - touch $HOME/.epoch/epoch/epoch.yaml
  - echo "
    ---
     peers:
         - "aenode://pp_2i8N6XsjCGe1wkdMhDRs7t7xzijrjJDN4xA22RoNGCgt6ay9QB@31.13.249.70:3011" # wrong port
     fork_management:
         network_id: "my_test" 
     chain:
         persist: true
     http:
         external:
           port: 3013
         internal:
           port: 3113
           listen_address: 0.0.0.0
           debug_endpoints: true
     mining:
         autostart: true
         expected_mine_rate: 100
         # Public key of beneficiary account that will receive fees from mining on a node.
         beneficiary: "ak_JV5aveau3CmasD5UfA1WanyJD9BRAow8315sdgcSRYTKUnrkk"
         cuckoo:
             miner:
                 # Use the fast executable binary of the miner.
                 executable: mean15-generic
                 # Extra arguments to pass to the miner executable binary.
                 extra_args: "-t 1"
                 # Use the smaller graph for faster mining
                 edge_bits: 15
    "  >> $HOME/.epoch/epoch/epoch.yaml
  - $HOME/aeternity/node/bin/aeternity start
  - git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.7.1
  - echo -e '\n. $HOME/.asdf/asdf.sh' >> ~/.bashrc
  - echo -e '\n. $HOME/.asdf/completions/asdf.bash' >> ~/.bashrc
  - source ~/.bashrc
  - asdf plugin-add java
  - asdf install java oracle-8.141
  - asdf plugin-add maven
  - asdf install maven 3.3.3
  - asdf global maven 3.3.3
  - asdf global java oracle-8.141
  - mix local.rebar --force
  - mix local.hex --force 
  - mix build_api v1.0.0-elixir v2.2.0 
  - mix deps.get
  - mix clean
  

install:
  # Install libsodium
  - mkdir -p libsodium-src
  - "[ -d $HOME/.libsodium/lib ] || (wget -O libsodium-src.tar.gz https://github.com/jedisct1/libsodium/releases/download/$LIBSODIUM_VER/libsodium-$LIBSODIUM_VER.tar.gz && tar -zxf libsodium-src.tar.gz -C libsodium-src --strip-components=1)"
  - cd libsodium-src
  - "[ -d $HOME/.libsodium/lib ] || (./configure --prefix=$HOME/.libsodium && make -j$(nproc) && make install && export LIBSODIUM_NEW=yes)"
  - cd ..

  # Recompile enacl if necessary
  - "[ -z $LIBSODIUM_NEW ] || (mix deps.compile enacl)"

script:
  - mix format --check-formatted
  - mix compile --warnings-as-errors
  - mix compile.xref --warnings-as-errors
  - mix coveralls -u --exclude disabled